%bcond_with input_pcap
%bcond_with input_dpdk
%bcond_with input_nfb
%bcond_with output_unirec
%bcond_with process_experimental

Name:          ipfixprobe
Version:       @VERSION@
Release:       @RELEASE@%{?dist}
Summary:       IPFIX flow exporter with various extending IPFIX elements exported by plugins.
URL:           https://github.com/CESNET/ipfixprobe
Group:         Liberouter
License:       BSD
Vendor:        CESNET, z.s.p.o.
BuildRoot:     %{_tmppath}/%{name}-%{version}-%{release}
Provides:      ipfixprobe
Source0:       %{name}-%{version}.tar.gz

%if %{with input_pcap}
%package input-pcap
Summary: Input plugin to read packets from files and interfaces using libpcap.

%description input-pcap
Input plugin for libpcap.

BuildRequires: libpcap-devel
Requires: libpcap
%endif

%if %{with input_dpdk}
%package input-dpdk
Summary: Input plugin to read packets from interfaces using dpdk.

%description input-dpdk
Input plugin for dpdk.

BuildRequires: dpdk-devel
Requires: dpdk
%endif

%if %{with input_nfb}
%package input-nfb
Summary: Input plugin to read packets from nfb cards.

%description input-nfb
Input plugin for nfb cards.

BuildRequires: nfb-framework
Requires: nfb-framework
%endif

%if %{with output_unirec}
%package output-unirec
Summary: Output plugin to export records in unirec format.

%description output-unirec
Output plugin for unirec.

BuildRequires: unirec
Requires: unirec
%endif

%if %{with process_experimental}
%package process-experimental
Summary: Experimental process plugins.

%description process-experimental
Experimental process plugins.

%endif

BuildRoot:     %{_tmppath}/%{name}-%{version}-%{release}
BuildRequires: gcc >= 8
BuildRequires: gcc-c++ >= 8
BuildRequires: make
BuildRequires: cmake >= 3.12
BuildRequires: libunwind-devel
BuildRequires: libatomic-devel
BuildRequires: pthread
Requires: libatomic   
Requires: fuse3
Requires: telemetry
Requires: lz4
Requires: openssl
BuildRequires: doxygen 
BuildRequires: pkgconfig
BuildRequires: lz4-devel
BuildRequires: openssl-devel

# Make sure that build is always performed out-of-source
%undefine __cmake_in_source_build

%description
The package contains tools, configuration files and traffic samples
that make up the main components of the test environment.

%prep
%autosetup

%build
%cmake -DCMAKE_BUILD_TYPE=Release %{?with_input_pcap:-DENABLE_INPUT_PCAP=ON} %{?with_input_dpdk:-DENABLE_INPUT_DPDK=ON} %{?with_input_nfb:-DENABLE_INPUT_NFB=ON} %{?with_output_unirec: -DENABLE_OUTPUT_UNIREC=ON} %{?with_process_experimental: -DENABLE_PROCESS_EXPERIMENTAL=ON}
%cmake_build

%install
%cmake_install

%files
%license LICENSE
%{_bindir}/ipfixprobe
%{_libdir}/ipfixprobe/input/libipfixprobe-input-raw.so

%{_libdir}/ipfixprobe/output/libipfixprobe-output-ipfix.so
%{_libdir}/ipfixprobe/output/libipfixprobe-output-text.so

%{_libdir}/ipfixprobe/process/libipfixprobe-process-basicplus.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-bstats.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-dns.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-dnssd.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-flowhash.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-http.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-icmp.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-pstats.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-phists.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-ovpn.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-vlan.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-osquery.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-netbios.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-tls.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-wg.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-smtp.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-quic.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-idpcontent.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-mqtt.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-passivedns.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-ssadetector.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-ssdp.so

%{_libdir}/ipfixprobe/storage/libipfixprobe-storage-cache.so

%if %{with input_pcap}
%files input-pcap
%{_libdir}/ipfixprobe/input/libipfixprobe-input-pcap.so
%endif

%if %{with input_nfb}
%files input-nfb
%{_libdir}/ipfixprobe/input/libipfixprobe-input-nfb.so
%endif

%if %{with input_dpdk}
%files input-dpdk
%{_libdir}/ipfixprobe/input/libipfixprobe-input-dpdk.so
%endif

%if %{with output_unirec}
%files output-unirec
%{_libdir}/ipfixprobe/output/libipfixprobe-output-unirec.so
%endif

%if %{with process_experimental}
%files process-experimental
%{_libdir}/ipfixprobe/process/libipfixprobe-process-nettisa.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-sip.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-rtsp.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-mpls.so
%{_libdir}/ipfixprobe/process/libipfixprobe-process-ntp.so
%endif

%changelog
